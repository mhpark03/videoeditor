 * Select image source for VEO video generation
 * @param {string} source - 'local' or 's3'
 */
export async function selectVeoImageSource(source) {
  console.log(`[VEO Video] Selecting ${source} image`);

  if (source === 'local') {
    // Select from local PC
    try {
      const filePath = await window.electronAPI.selectMedia('image');

      if (!filePath) {
        console.log('[VEO Video] No file selected');
        return;
      }

      console.log('[VEO Video] Selected local file:', filePath);

      // Store in global state
      veoImage = {
        source: 'local',
        filePath: filePath,
        preview: `file://${filePath}`
      };

      // Update preview
      updateVeoImagePreview();

      // Update button states
      updateVeoSourceButtons('local');
    } catch (error) {
      console.error('[VEO Video] Error selecting local image:', error);
      alert('이미지 선택 중 오류가 발생했습니다.');
    }
  } else if (source === 's3') {
    // Select from S3
    try {
      // Open S3 image selector modal
      await openVeoS3ImageSelector();

      // Update button states
      updateVeoSourceButtons('s3');
    } catch (error) {
      console.error('[VEO Video] Error opening S3 selector:', error);
      alert('S3 이미지 선택 중 오류가 발생했습니다.');
    }
  }
}

/**
 * Update source button states
 * @param {string} activeSource - 'local' or 's3'
 */
export function updateVeoSourceButtons(activeSource) {
  const localBtn = document.getElementById('veo-img-source-local');
  const s3Btn = document.getElementById('veo-img-source-s3');

  if (localBtn && s3Btn) {
    if (activeSource === 'local') {
      localBtn.style.background = '#667eea';
      s3Btn.style.background = '#444';
    } else {
      localBtn.style.background = '#444';
      s3Btn.style.background = '#667eea';
    }
  }
}

/**
 * Update VEO image preview
 */
export function updateVeoImagePreview() {
  const previewDiv = document.getElementById('veo-img-preview');

  if (!previewDiv) return;

  if (veoImage && veoImage.preview) {
    previewDiv.innerHTML = `
      <img src="${veoImage.preview}" style="width: 100%; height: 100%; object-fit: contain;" />
      <button
        onclick="window.clearVeoImage()"
        style="position: absolute; top: 5px; right: 5px; background: rgba(220, 53, 69, 0.9); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; padding: 0;"
      >✕</button>
      <div style="position: absolute; bottom: 5px; left: 5px; background: rgba(0, 0, 0, 0.7); color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">
        ${veoImage.source === 's3' ? '서버' : 'PC'}
      </div>
    `;
  } else {
    previewDiv.innerHTML = `<span style="color: #888; font-size: 13px;">이미지를 선택하세요</span>`;
  }
}

/**
 * Clear selected VEO image
 */
export function clearVeoImage() {
  veoImage = null;
  updateVeoImagePreview();
  console.log('[VEO Video] Cleared image');
}

/**
 * Open S3 image selector modal for VEO
 */
async function openVeoS3ImageSelector() {
  console.log('[VEO Video] Opening S3 image selector');

  try {
    // Fetch images from backend
    const response = await fetch('http://localhost:8080/api/videos/images');

    if (!response.ok) {
      throw new Error(`Failed to fetch images: ${response.status}`);
    }

    const images = await response.json();
    console.log(`[VEO Video] Loaded ${images.length} images from S3`);

    // Create modal
    const modal = document.createElement('div');
    modal.id = 'veo-s3-modal';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;

    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: #1e1e2e;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
    `;

    const title = document.createElement('h3');
    title.textContent = '서버 이미지 선택';
    title.style.cssText = 'color: #667eea; margin-bottom: 15px;';

    const grid = document.createElement('div');
    grid.style.cssText = `
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    `;

    // Add images
    images.forEach(image => {
      const imgCard = document.createElement('div');
      imgCard.style.cssText = `
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        transition: border-color 0.3s;
      `;

      imgCard.innerHTML = `
        <img src="${image.url}" style="width: 100%; height: 120px; object-fit: cover;" />
        <div style="padding: 8px; background: #2d2d2d;">
          <div style="color: white; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${image.title || 'Untitled'}</div>
        </div>
      `;

      imgCard.onmouseover = () => imgCard.style.borderColor = '#667eea';
      imgCard.onmouseout = () => imgCard.style.borderColor = 'transparent';

      imgCard.onclick = () => {
        veoImage = {
          source: 's3',
          filePath: image.url,
          preview: image.url
        };
        updateVeoImagePreview();
        document.body.removeChild(modal);
        console.log('[VEO Video] Selected S3 image:', image.url);
      };

      grid.appendChild(imgCard);
    });

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '닫기';
    closeBtn.className = 'property-btn';
    closeBtn.style.cssText = 'width: 100%; margin-top: 10px;';
    closeBtn.onclick = () => document.body.removeChild(modal);

    modalContent.appendChild(title);
    modalContent.appendChild(grid);
    modalContent.appendChild(closeBtn);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);

  } catch (error) {
    console.error('[VEO Video] Failed to open S3 image selector:', error);
    alert('서버 이미지 목록을 불러오는 중 오류가 발생했습니다.');
  }
}

/**
 * Generate video with VEO (Image to Video)
 */
export async function executeGenerateVideoVeo() {
  const prompt = document.getElementById('video-prompt-veo')?.value?.trim();
  const duration = document.getElementById('video-duration-veo')?.value || '4';
  const resolution = document.getElementById('video-resolution-veo')?.value || '720p';
  const aspectRatio = document.getElementById('video-aspect-veo')?.value || '16:9';

  // Validate inputs
  if (!prompt) {
    alert('프롬프트를 입력해주세요.');
    return;
  }

  if (!veoImage) {
    alert('시작 이미지를 선택해주세요.');
    return;
  }

  try {
    console.log('[VEO Video] Starting video generation...');
    console.log('[VEO Video] Prompt:', prompt);
    console.log('[VEO Video] Duration:', duration);
    console.log('[VEO Video] Resolution:', resolution);
    console.log('[VEO Video] Aspect Ratio:', aspectRatio);
    console.log('[VEO Video] Image:', veoImage);

    if (typeof window.updateProgress === 'function') {
      window.updateProgress(10, '영상 생성 준비 중...');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('영상 생성 준비 중...');
    }

    // Prepare form data
    const formData = new FormData();
    formData.append('prompt', prompt);
    formData.append('duration', duration);
    formData.append('resolution', resolution);
    formData.append('aspectRatio', aspectRatio);

    // Convert image to base64 for API call
    let imageBase64;
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(15, '이미지 로드 중...');
    }

    if (veoImage.source === 'local') {
      const imageResponse = await fetch(`file://${veoImage.filePath}`);
      const imageBlob = await imageResponse.blob();

      // Use FileReader to convert blob to base64 (avoids stack overflow for large images)
      imageBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          // Remove the data URL prefix (e.g., "data:image/jpeg;base64,")
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(imageBlob);
      });
    } else if (veoImage.source === 's3') {
      const imageResponse = await fetch(veoImage.filePath);
      const imageBlob = await imageResponse.blob();

      // Use FileReader to convert blob to base64
      imageBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64String = reader.result.split(',')[1];
          resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(imageBlob);
      });
    }

    if (typeof window.updateProgress === 'function') {
      window.updateProgress(30, 'Google VEO API 요청 중...');
    }

    // Call Google VEO API via Electron main process
    const result = await window.electronAPI.generateVeoVideo({
      prompt: prompt,
      imageBase64: imageBase64,
      duration: duration,
      resolution: resolution,
      aspectRatio: aspectRatio
    });

    console.log('[VEO Video] Generation result:', result);

    if (!result.success || !result.videoUrl) {
      throw new Error('Video generation failed or video URL not found');
    }

    // Store generated video info
    generatedVeoVideo = {
      url: result.videoUrl,
      taskId: result.taskId
    };

    if (typeof window.updateProgress === 'function') {
      window.updateProgress(100, '영상 생성 완료!');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('영상 생성 완료!');
    }

    // Show success message
    alert(`영상이 생성되었습니다!\n\nTask ID: ${result.taskId}\n\n영상을 재생하거나 S3에 저장할 수 있습니다.`);

    // Show preview section
    const previewSection = document.getElementById('veo-video-preview-section');
    if (previewSection) {
      previewSection.style.display = 'block';
    }

    console.log('[VEO Video] Video generated successfully');

  } catch (error) {
    console.error('[VEO Video] Generation failed:', error);
    alert('영상 생성 중 오류가 발생했습니다: ' + error.message);
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(0, '');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('');
    }
  }
}

/**
 * Save generated VEO video to S3
 */
export async function saveVeoVideoToS3() {
  if (!generatedVeoVideo || !generatedVeoVideo.url) {
    alert('저장할 영상이 없습니다. 먼저 영상을 생성해주세요.');
    return;
  }

  const title = document.getElementById('ai-video-title-veo')?.value?.trim();
  const description = document.getElementById('ai-video-description-veo')?.value?.trim();

  if (!title) {
    alert('제목을 입력해주세요.');
    return;
  }

  try {
    console.log('[VEO Video] Saving to S3...');
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(10, 'S3 저장 준비 중...');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('S3 저장 중...');
    }

    // Download video from VEO URL
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(20, '영상 다운로드 중...');
    }
    const videoResponse = await fetch(generatedVeoVideo.url);
    if (!videoResponse.ok) {
      throw new Error('Failed to download generated video');
    }

    const videoBlob = await videoResponse.blob();
    console.log('[VEO Video] Video downloaded, size:', videoBlob.size);

    // Upload to S3 via backend
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(50, 'S3 업로드 중...');
    }
    const formData = new FormData();
    formData.append('file', videoBlob, `veo_${Date.now()}.mp4`);
    formData.append('title', title);
    formData.append('description', description || '');

    const uploadResponse = await fetch('http://localhost:8080/api/ai/upload', {
      method: 'POST',
      body: formData
    });

    if (!uploadResponse.ok) {
      throw new Error(`S3 upload failed: ${uploadResponse.status}`);
    }

    const uploadResult = await uploadResponse.json();
    console.log('[VEO Video] Upload result:', uploadResult);

    if (typeof window.updateProgress === 'function') {
      window.updateProgress(100, 'S3 저장 완료!');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('S3 저장 완료!');
    }

    alert('영상이 S3에 저장되었습니다!\n\n' +
          `제목: ${title}\n` +
          `설명: ${description}\n\n` +
          '⚙️ 백엔드 API와 연동하여 S3에 자동 업로드되었습니다.');

    console.log('[VEO Video] Saved to S3 successfully');

    // Clear form
    document.getElementById('ai-video-title-veo').value = '';
    document.getElementById('ai-video-description-veo').value = '';

  } catch (error) {
    console.error('[VEO Video] S3 upload failed:', error);
    alert('S3 저장 중 오류가 발생했습니다: ' + error.message);
    if (typeof window.updateProgress === 'function') {
      window.updateProgress(0, '');
    }
    if (typeof window.updateStatus === 'function') {
      window.updateStatus('');
    }
  }
}

/**
 * Get current VEO video
 * @returns {object|null} - Generated video object
 */
export function getGeneratedVeoVideo() {
  return generatedVeoVideo;
}
