<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: file: blob: https://*.s3.ap-northeast-2.amazonaws.com https://*.s3.amazonaws.com https://*.cloudfront.net; media-src 'self' data: file: blob: https://generativelanguage.googleapis.com; connect-src 'self' http://localhost:* http://127.0.0.1:* https://*.s3.ap-northeast-2.amazonaws.com https://*.s3.amazonaws.com https://*.cloudfront.net https://generativelanguage.googleapis.com;">
  <title>Kiosk Video Editor - 고급 영상/음성 편집 [UPDATED]</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1>Kiosk Video Editor</h1>
        <p class="subtitle">고급 영상/음성 편집 도구</p>
      </div>
      <div class="header-right">
        <div class="mode-switch" id="mode-switch-container" style="display: none;">
          <button class="mode-btn active" id="video-mode-btn" data-mode="video">
            🎬 영상 편집
          </button>
          <button class="mode-btn" id="audio-mode-btn" data-mode="audio">
            🎵 음성 편집
          </button>
          <button class="mode-btn" id="content-mode-btn" data-mode="content">
            ✨ 컨텐츠 생성
          </button>
        </div>
        <div id="user-info" style="display: none; color: #e0e0e0; font-size: 14px;">
          <span id="user-email"></span>
        </div>
        <button id="logout-btn" style="display: none; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; margin-left: 15px;">로그아웃</button>
      </div>
    </header>

    <!-- Login Modal -->
    <div id="login-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: #2a2a2a; padding: 30px; border-radius: 8px; width: 400px; max-width: 90%;">
        <h2 style="margin: 0 0 8px 0; color: #e0e0e0;">로그인</h2>
        <p style="margin: 0 0 20px 0; color: #888; font-size: 13px;">
          ⚠️ 관리자 계정만 로그인할 수 있습니다
        </p>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 14px;">서버 선택</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button id="server-local-btn" class="server-select-btn" onclick="selectServer('local')" style="flex: 1; padding: 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">로컬</button>
            <button id="server-dev-btn" class="server-select-btn" onclick="selectServer('dev')" style="flex: 1; padding: 10px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">개발</button>
            <button id="server-custom-btn" class="server-select-btn" onclick="selectServer('custom')" style="flex: 1; padding: 10px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600;">직접입력</button>
          </div>
          <input type="text" id="backend-url" placeholder="http://localhost:8080" value="http://localhost:8080" readonly
                 style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0; font-size: 14px;"/>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 14px;">이메일</label>
          <input type="email" id="login-email" placeholder="이메일 주소"
                 style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0; font-size: 14px;"/>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; color: #aaa; font-size: 14px;">비밀번호</label>
          <input type="password" id="login-password" placeholder="비밀번호"
                 style="width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #e0e0e0; font-size: 14px;"/>
        </div>

        <div id="login-error" style="display: none; padding: 10px; background: #dc2626; color: white; border-radius: 4px; margin-bottom: 15px; font-size: 13px;"></div>

        <div style="display: flex; gap: 10px;">
          <button id="login-submit-btn" onclick="handleLogin()" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600;">로그인</button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content" style="display: none;">
      <!-- Sidebar - Tool Panel -->
      <aside class="sidebar">
        <h2>편집 도구</h2>

        <div class="tool-section">
          <h3>기본 작업</h3>
          <button class="tool-btn" data-tool="import">
            <span class="icon">📁</span>
            영상 가져오기
          </button>
          <button class="tool-btn" data-tool="trim">
            <span class="icon">✂️</span>
            영상 자르기
          </button>
          <button class="tool-btn" data-tool="merge">
            <span class="icon">🔗</span>
            영상 병합
          </button>
        </div>

        <div class="tool-section">
          <h3>오디오</h3>
          <button class="tool-btn" data-tool="generate-tts">
            <span class="icon">🗣️</span>
            TTS 음성 생성
          </button>
          <button class="tool-btn" data-tool="trim-audio">
            <span class="icon">✂️</span>
            오디오 자르기
          </button>
          <button class="tool-btn" data-tool="merge-audio">
            <span class="icon">🔗</span>
            오디오 병합
          </button>
          <button class="tool-btn" data-tool="add-audio">
            <span class="icon">🎵</span>
            오디오 삽입
          </button>
          <button class="tool-btn" data-tool="extract-audio">
            <span class="icon">🎤</span>
            오디오 추출
          </button>
          <button class="tool-btn" data-tool="volume">
            <span class="icon">🔊</span>
            볼륨 조절
          </button>
        </div>

        <div class="tool-section">
          <h3>효과</h3>
          <button class="tool-btn" data-tool="filter">
            <span class="icon">🎨</span>
            필터/색상 조정
          </button>
          <button class="tool-btn" data-tool="quality">
            <span class="icon">⚙️</span>
            품질/해상도 조절
          </button>
          <button class="tool-btn" data-tool="text">
            <span class="icon">📝</span>
            텍스트/자막
          </button>
          <button class="tool-btn" data-tool="speed">
            <span class="icon">⚡</span>
            속도 조절
          </button>
        </div>

        <div class="tool-section">
          <h3>내보내기</h3>
          <button class="tool-btn export-btn" data-tool="export">
            <span class="icon">💾</span>
            비디오 내보내기
          </button>
        </div>
      </aside>

      <!-- Center - Preview & Timeline -->
      <main class="editor-area">
        <!-- Video Preview -->
        <div class="preview-container">
          <div id="video-preview" class="video-preview">
            <video id="preview-video">
              <source src="" type="video/mp4">
            </video>
            <audio id="preview-audio" style="display: none;">
              Your browser does not support the audio element.
            </audio>
            <div id="audio-placeholder" style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; flex-direction: column; background: #1a1a1a;">
              <div style="font-size: 64px; margin-bottom: 20px;">🎵</div>
              <div style="color: #e0e0e0; font-size: 18px; font-weight: 600;">음성 파일</div>
              <div id="audio-filename" style="color: #aaa; font-size: 14px; margin-top: 10px;"></div>
              <div style="color: #888; font-size: 13px; margin-top: 20px;">하단 타임라인 컨트롤을 사용하여 재생하세요</div>
            </div>
            <img id="generated-image-preview" style="display: none; width: 100%; height: 100%; object-fit: contain;" />
            <div id="text-overlay" class="text-overlay" style="display: none;"></div>
            <div id="preview-placeholder" class="preview-placeholder">
              <p>영상을 가져와주세요</p>
            </div>
          </div>

          <!-- Video Info -->
          <div id="video-info" class="video-info" style="display: none;">
            <span id="info-duration">00:00:00.00</span>
            <span id="info-resolution">0x0</span>
            <span id="info-fps">0 fps</span>
            <span id="info-size">0 MB</span>
          </div>
        </div>

        <!-- Timeline -->
        <div class="timeline-container">
          <div class="timeline-controls">
            <button id="play-pause-btn" class="timeline-btn timeline-btn-icon" disabled data-state="paused" title="재생">▶️</button>
            <span id="current-time" class="time-display">00:00:00.00</span>
            <div class="timeline-slider-container">
              <div id="trim-range-overlay" class="trim-range-overlay" style="display: none;"></div>
              <div id="text-range-overlay" class="text-range-overlay" style="display: none;"></div>
              <div id="audio-range-overlay" class="audio-range-overlay" style="display: none;"></div>
              <div id="zoom-range-overlay" class="zoom-range-overlay" style="display: none;"></div>
              <div id="slider-drag-selection" class="slider-drag-selection" style="display: none;"></div>
              <input type="range" id="timeline-slider" class="timeline-slider" min="0" max="100" value="0" step="0.01" disabled>
            </div>
          </div>

          <!-- Multi-track Timeline -->
          <div class="tracks">
            <div class="track video-track">
              <div class="track-label">Video</div>
              <div class="track-content" id="video-track"></div>
            </div>
            <div class="track audio-track">
              <div class="track-label">Audio</div>
              <div class="track-content" id="audio-track">
                <div class="channel-labels" id="channel-labels" style="display: none;">
                  <div class="channel-label left-label">L</div>
                  <div class="channel-label right-label">R</div>
                </div>
                <div id="silent-audio-indicator" class="silent-audio-indicator" style="display: none;">
                  <span>🔇 무음 오디오 트랙 (Silent Audio Track)</span>
                </div>
                <img id="audio-waveform" class="audio-waveform" style="display: none;" />
                <div id="playhead-bar" class="playhead-bar" style="display: none;"></div>
                <div id="zoom-selection" class="zoom-selection" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Right Panel - Properties -->
      <aside class="properties-panel">
        <h2>속성</h2>
        <div id="tool-properties" class="tool-properties">
          <p class="placeholder-text">편집 도구를 선택하세요</p>
        </div>

        <!-- Progress Section -->
        <div id="progress-section" class="progress-section" style="display: none;">
          <h3>처리 중...</h3>
          <div class="progress-bar">
            <div id="progress-fill" class="progress-fill"></div>
          </div>
          <p id="progress-text" class="progress-text">대기 중...</p>
        </div>
      </aside>
    </div>

    <!-- Status Bar -->
    <footer class="status-bar">
      <span id="status-text">준비</span>
      <span id="current-file">파일 없음</span>
    </footer>
  </div>

  <!-- Modals -->
  <div id="modal-overlay" class="modal-overlay" style="display: none;">
    <div id="modal-content" class="modal-content"></div>
  </div>

  <script src="modules/PreviewManager.js"></script>
  <script type="module">
    import { initializeModules } from './modules/module-loader.js';
    document.addEventListener('DOMContentLoaded', () => {
      initializeModules();
    });
  </script>
  <script type="module" src="app.js"></script>
</body>
</html>
